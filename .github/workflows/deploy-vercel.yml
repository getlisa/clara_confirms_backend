name: Deploy to Vercel

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string
      environment:
        description: 'Deployment target'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          set -euo pipefail

          TARGET="${{ github.event.inputs.environment }}"
          BRANCH="${{ github.event.inputs.branch }}"
          echo "Deploying branch '$BRANCH' to $TARGET..."

          if [ -z "${VERCEL_TEAM_ID:-}" ]; then
            DEPLOY_URL="https://api.vercel.com/v13/deployments"
          else
            DEPLOY_URL="https://api.vercel.com/v13/deployments?teamId=${VERCEL_TEAM_ID}"
          fi

          RESPONSE="$(curl -sS -X POST "$DEPLOY_URL" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"clara-confirms-backend\",
              \"project\": \"prj_k2T5i9l3qTcklxa1Gnle69k6cQ48\",
              \"target\": \"$TARGET\",
              \"gitSource\": {
                \"type\": \"github\",
                \"repo\": \"getlisa/clara_confirms_backend\",
                \"ref\": \"$BRANCH\",
                \"repoId\": 1162888161
              }
            }")"

          echo "$RESPONSE"

          export RESPONSE_JSON="$RESPONSE"
          python3 - <<'PY'
          import json
          import os
          import sys

          data = json.loads(os.environ.get("RESPONSE_JSON", "{}"))
          error = data.get("error")
          if error:
              if isinstance(error, dict):
                  message = error.get("message", str(error))
              else:
                  message = str(error)
              print(f"Vercel deploy failed: {message}")
              sys.exit(1)

          url = data.get("url")
          if not url:
              print("Vercel deploy failed: missing deployment URL")
              sys.exit(1)

          print(f"Deployment URL: https://{url}")
          PY
